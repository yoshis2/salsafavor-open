# OpenSpec 指示書

このプロジェクトでは、開発プロセスの一貫性と品質を担保するために **OpenSpec プロトコル** を採用しています。
AIアシスタントは、以下のガイドライン、ワークフロー、およびプロジェクト規約を厳守して作業を行ってください。

## 1. コア・プリンシプル (Core Principles)

### 🚀 変更管理の哲学

コードを書く前に、必ず「計画」と「設計」をドキュメント化します。行き当たりばったりの実装は禁止されています。
特に本プロジェクトは **「レガシー（Blade/jQuery）からモダン（Inertia/React/Tailwind）への移行過渡期」** にあるため、既存機能を破壊せずに新しいスタックを導入する慎重な設計が求められます。

### 🤖 自律的判断の基準

以下のキーワードや状況に遭遇した場合、即座にコーディングを開始せず、まず OpenSpec ワークフロー（提案フェーズ）を開始してください：

- 「提案 (proposal)」「仕様 (spec)」「計画 (plan)」「設計 (design)」という言葉が含まれる場合。
- 新機能の追加、データベース構造の変更、アーキテクチャの変更を行う場合。
- 指示が曖昧で、要件定義が必要な場合。
- **「BladeファイルをReactコンポーネントに移行する」** などのリファクタリング作業。

---

## 2. OpenSpec ワークフロー (Workflow)

作業は以下の 4 つのフェーズで進行します。各フェーズの完了条件を厳守してください。

### Phase 1: 提案と設計 (Proposal & Design)

変更を加える前に、ドキュメントで合意形成を行います。

1. **コンテキストの理解**:

- `openspec/project.md` を読み、プロジェクトの目的、技術スタック、制約事項を確認します。
- 既存のコードや仕様（`openspec/specs/`）を検索し、重複や競合がないか確認します。

2. **スキャフォールディング**:

- 動詞から始まる一意なID（例: `migrate-auth-pages`）を決定します。
- `openspec/changes/<id>/` 配下に `proposal.md`, `design.md`, `tasks.md` を作成します。

3. **ドキュメント作成ルール (厳守)**:

- **言語**: すべて **日本語** で記述してください。
- **Design.md (必須)**: アーキテクチャ上の決定、データフロー、コンポーネント構成を **400文字以上** で詳細に記述してください。特に Blade と React の共存（ハイブリッド構成）に関する戦略は必須です。
- **Spec.md**: ページや機能ごとに個別のスペックファイルを作成してください。

4. **検証**:

- `openspec validate <id> --strict` を実行し、形式的なエラーがないか確認します。

### Phase 2: レビュー (Review)

作成した提案書をユーザーに提示し、承認を得ます。

- ユーザーからのフィードバックがある場合はドキュメントを修正します。
- **この段階ではまだ実装コード（`.php`, `.tsx` 等）を書きません。**

### Phase 3: 実装と適用 (Implementation & Apply)

承認された設計に基づき、コードを変更します。

1. **タスク駆動開発**:

- `tasks.md` を読み込み、未完了のタスクを上から順に **1つずつ** 実行します。
- **重要**: `tasks.md` を更新する際は、必ず直前に `read_file` で最新の状態を取得し、他のタスクを消したり省略したりせずに、該当箇所のチェックボックスのみを `[x]` に更新してください。

2. **プロセス管理**:

- `npm run dev` 等のサーバー起動コマンドを実行する際は、必ず `ps` 等で既存プロセスを確認し、重複起動（ポート競合）を防ぐために既存プロセスを終了させてから実行してください。
- Docker環境でのコマンド実行ルール（`docker compose exec ...`）に従ってください。

3. **ループ実行**:

- 1つのタスクが完了したら、自律的に次のタスクに着手してください（ユーザーの指示待ちにしない）。

### Phase 4: アーカイブ (Archive)

すべてのタスクが完了したら、変更を記録として保存します。

- `openspec archive <id>` を実行し、変更内容を `openspec/history/` へ移動します。

---

## 3. プロジェクト規約 (Project Conventions)

`openspec/project.md` に基づく主要な規約です。

### 🛠 技術スタック

- **Backend**: PHP 8.4 / Laravel 12 (Target)
- **Frontend (Modern)**: Inertia.js v2, React 19, TypeScript, Tailwind CSS v4 (Prefixなし)
- **Frontend (Legacy)**: Blade Templates, Bootstrap 4/5, jQuery
- **Infrastructure**: Docker (Sail), Xserver (Production)

### 📝 コーディングスタイル

- **PHP**: PSR-12 準拠。クラス名・メソッド名は英語で命名。
- **React/TS**: Functional Components, Hooks, PascalCase命名。
- **型定義**: TypeScriptの `any` は原則禁止。Laravelから渡される Props には必ず型を定義する。

### 🏗 アーキテクチャ・パターン

- **Strangler Fig Pattern (絞め殺し植物パターン)**:
- 一気に全てを書き換えるのではなく、ページ単位・コンポーネント単位で段階的に移行します。
- 共通レイアウト（Header/Footer）は、Blade版とReact版の両方で整合性を保つ必要があります。

- **ハイブリッド構成**:
- BladeルートとInertiaルートが混在することを許容します。
- リンク遷移は、SPA遷移（`<Link>`）と通常遷移（`<a>`）を適切に使い分けてください。

### 🧪 テスト戦略

- 新規実装および React 化する機能については、Feature Test (PHPUnit) または Component Test の作成を必須とします。
- 既存のレガシーコードにはテストが少ないため、リファクタリング時は挙動を変えないよう注意深く進めてください。

---

## 4. エージェントの禁止事項と注意点

1. **ドキュメントの省略禁止**:

- `proposal.md` や `design.md` を数行の箇条書きで済ませることは禁止です。文脈、リスク、代替案を含めて文章で記述してください。

2. **勝手な仕様変更の禁止**:

- 承認された `spec.md` に記載されていない機能を実装しないでください。必要が生じた場合は、まず仕様書を更新し、再承認を得てください。

3. **ファイルの破壊的更新の禁止**:

- 特に `tasks.md` や `spec.md` を更新する際、既存の内容を意図せず削除しないよう、`apply_diff` を使用するか、ファイル全体を読み込んでから書き込む手順を徹底してください。

4. **インフラ制約の遵守**:

- 本番環境（Xserver）では Node.js の常駐プロセスが制限されます。SSR（Server-Side Rendering）に依存しすぎない実装、またはPHP側でのフォールバック策を考慮してください。

### ⚠️ コマンド実行の絶対ルール (Sail Enforced)

このリポジトリでは、ホスト環境のコマンド（`php`, `composer`, `npm`）の使用を**禁止**します。
すべてのコマンドは **Laravel Sail** を介して実行してください。

- ❌ `php artisan migrate`
- ✅ `./vendor/bin/sail artisan migrate`

※ エイリアスが設定されていない場合があるため、`sail` ではなくフルパス `./vendor/bin/sail` の使用を推奨します。

---

## 5. リファレンス (Reference)

詳細なルールやテンプレートについては、以下のファイルを常に参照してください。

- **エージェントガイド**: `@/openspec/AGENTS.md`
- **プロジェクト仕様**: `@/openspec/project.md`
- **スタイルガイド**: `@/.gemini/styleguide.md`

この指示書に従い、高品質で持続可能な開発に貢献してください。
